<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Antivirus Evasion Techniques &mdash; PowerHub 2.0.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Usage" href="usage.html" />
    <link rel="prev" title="Changelog" href="changelog.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            PowerHub
          </a>
              <div class="version">
                2.0.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation and Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">Motivation &amp; Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="new.html">New in PowerHub 2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Antivirus Evasion Techniques</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#network-monitoring">Network Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#technique">Technique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#our-bypass">Our Bypass</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#file-system-monitoring">File System Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Technique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Our Bypass</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#amsi">AMSI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">Technique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">Our Bypass</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#entropy-analysis">Entropy Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">Technique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">Our Bypass</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#api-hooking">API Hooking</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">Technique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">Our Bypass</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#static-analysis">Static Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">Technique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#incremental-delivery">Our Bypass</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#behavior-analysis">Behavior Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id11">Technique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">Our Bypass</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#counter-measures">Counter measures</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="contrib.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PowerHub</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Antivirus Evasion Techniques</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/evasion.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
             
  <section id="antivirus-evasion-techniques">
<h1>Antivirus Evasion Techniques<a class="headerlink" href="#antivirus-evasion-techniques" title="Permalink to this heading"></a></h1>
<p>Let’s discuss some common antivirus detection techniques and how PowerHub
attempts to bypass them.</p>
<section id="network-monitoring">
<h2>Network Monitoring<a class="headerlink" href="#network-monitoring" title="Permalink to this heading"></a></h2>
<section id="technique">
<h3>Technique<a class="headerlink" href="#technique" title="Permalink to this heading"></a></h3>
<p>Antivirus detection does not necessarily have to happen on the endpoint.
It’s common to check files transferred from the network for malicious code
before it even reaches the endpoint. Usually, this happens in web proxies.</p>
</section>
<section id="our-bypass">
<h3>Our Bypass<a class="headerlink" href="#our-bypass" title="Permalink to this heading"></a></h3>
<p>PowerHub support HTTPS. Since some antivirus products perform TLS
inspection, almost all data is encrypted on an additional layer using either
RC4 or AES. Yes, RC4 is insecure, but practical attacks are still
sufficiently difficult for antivirus products.</p>
</section>
</section>
<section id="file-system-monitoring">
<h2>File System Monitoring<a class="headerlink" href="#file-system-monitoring" title="Permalink to this heading"></a></h2>
<section id="id1">
<h3>Technique<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>Whenever a file is written to disk, antivirus checks it against known
malware.</p>
</section>
<section id="id2">
<h3>Our Bypass<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>Easy: Don’t write anything to disk. PowerShell makes it possible to execute
code entirely in-memory.</p>
</section>
</section>
<section id="amsi">
<h2>AMSI<a class="headerlink" href="#amsi" title="Permalink to this heading"></a></h2>
<section id="id3">
<h3>Technique<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h3>
<p>Whenever PowerShell executes a script, it is first passed to the antivirus
product which checks it for malicious code. This check is often quite
primitive, such that it was at some point sufficient to replace
<code class="docutils literal notranslate"><span class="pre">Invoke-Mimikatz</span></code> with <code class="docutils literal notranslate"><span class="pre">Invoke-Mimidogz</span></code>. The mere presence of some IT
security researcher’s name is sometimes enough to trigger an antivirus.</p>
</section>
<section id="id4">
<h3>Our Bypass<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h3>
<p>PowerHub doesn’t use any novel AMSI bypass. There are long
<a class="reference external" href="https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell">lists</a> of AMSI
bypasses, because PowerShell is so powerful, it can modify its own behavior.</p>
<p>The challenge is to get one of the bypasses by AMSI itself, because the
bypasses are obviously immediately detected if executed naively. Some
bypasses are quite short and the only suspicious thing about them are some
strings. For example, this is one of the first bypasses by Matt Graeber and
it fits in a Tweet:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="no">[Ref]</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="s1">&#39;System.Management.Automation.AmsiUtils&#39;</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="s1">&#39;amsiInitFailed&#39;</span><span class="p">,</span><span class="s1">&#39;NonPublic,Static&#39;</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="nv">$null</span><span class="p">,</span><span class="nv">$true</span><span class="p">)</span>
</pre></div>
</div>
<p>In fact, Windows Defender will consider this malicious simply because it
contains the string <code class="docutils literal notranslate"><span class="pre">AmsiUtils</span></code>. Try it out: Open a PowerShell and type
<code class="docutils literal notranslate"><span class="pre">&quot;AmsiUtil&quot;</span></code>. Then type <code class="docutils literal notranslate"><span class="pre">&quot;AmsiUtils&quot;</span></code>:</p>
<p><img alt="AmsiUtils are malicious" src="_images/amsiutils.png" /></p>
<p>Imagine we replaced the strings:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="no">[Ref]</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="nv">$string1</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="nv">$string2</span><span class="p">,</span><span class="nv">$string3</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="nv">$Null</span><span class="p">,</span><span class="nv">$True</span><span class="p">)</span>
</pre></div>
</div>
<p>Surely this line cannot be considered malicious, or else it would probably break
legitimate scripts. So if we manage to obfuscate the original strings, we
should be good. There are infinite ways to obfuscate a string. You can split
them up, rearrange them using format strings, put them together from bytes,
work with replacement rules, and much, much more.
Daniel Bohannon has worked out a <a class="reference external" href="https://github.com/danielbohannon/Invoke-Obfuscation">whole bunch of obfuscation
methods</a>, not only for
strings, but also for other PowerShell “tokens”.</p>
<p>In PowerHub, we take an even more systematic approach: Strings are
“obfuscated” using the RC4 encryption algorithm. It’s simple enough so it
can be implemented in a couple of lines of pure PowerShell, and while
technically broken, still strong enough to throw off automated detection
techniques, especially if they are supposed to work in the background
without affecting the user’s workflow.</p>
</section>
</section>
<section id="entropy-analysis">
<h2>Entropy Analysis<a class="headerlink" href="#entropy-analysis" title="Permalink to this heading"></a></h2>
<section id="id5">
<h3>Technique<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h3>
<p>Overly obfuscated code looks <em>weird</em>. You’d be able to spot it a mile away.
Machines can be made to recognize it as well, by means of frequency analysis
of individual letters or, more generally, entropy analysis. Daniel Bohannon,
who worked on obfuscating code, also suggested ways to <a class="reference external" href="https://www.blackhat.com/docs/us-17/thursday/us-17-Bohannon-Revoke-Obfuscation-PowerShell-Obfuscation-Detection-And%20Evasion-Using-Science-wp.pdf">defeat code
obfuscation</a> together with Lee Holems.</p>
</section>
<section id="id6">
<h3>Our Bypass<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h3>
<p>We (optionally) wrap our code in legit PowerShell code. Downloaded from one of
Microsoft’s GitHub repositories, PowerHub has hundreds of modules that do
nothing and which will be randomly chosen to pad suspicious code. Plus,
instead of using randomly generated variable names, PowerHub can use
variable names inspired by real code to make it look more natural.</p>
<p>We will still have large encoded binary blobs in our code, but we must
assume that it won’t be feasible for antivirus products to block all scripts
with blobs in them. There is no way around this – I think.</p>
</section>
</section>
<section id="api-hooking">
<h2>API Hooking<a class="headerlink" href="#api-hooking" title="Permalink to this heading"></a></h2>
<section id="id7">
<h3>Technique<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h3>
<p>Hooking certain routines, such as the AES decryption routine, actually makes
sense. If a process decrypts data that contains naughty strings like
<code class="docutils literal notranslate"><span class="pre">Mimikatz</span></code>, it is killed immediately by some antivirus products.</p>
</section>
<section id="id8">
<h3>Our Bypass<a class="headerlink" href="#id8" title="Permalink to this heading"></a></h3>
<p>PowerHub has the option to stick to RC4, which doesn’t use any APIs. It’s
noticeably slower but should be stealthier at the same time.</p>
</section>
</section>
<section id="static-analysis">
<h2>Static Analysis<a class="headerlink" href="#static-analysis" title="Permalink to this heading"></a></h2>
<section id="id9">
<h3>Technique<a class="headerlink" href="#id9" title="Permalink to this heading"></a></h3>
<p>Malicious code such as the cradle itself could be detected simply by
blocking code which contains both <code class="docutils literal notranslate"><span class="pre">DownloadString</span></code> and <code class="docutils literal notranslate"><span class="pre">Invoke-Expression</span></code>.</p>
</section>
<section id="incremental-delivery">
<span id="id10"></span><h3>Our Bypass<a class="headerlink" href="#incremental-delivery" title="Permalink to this heading"></a></h3>
<p>PowerHub has two approaches. One is the “incremental delivery”, by which
pieces of the stager are loaded incrementally. To avoid the cradle itself
being detected, PowerHub knows the option “split cradle”. You will then have
to execute two commands in the same PowerShell session, which may not always
be possible.</p>
</section>
</section>
<section id="behavior-analysis">
<h2>Behavior Analysis<a class="headerlink" href="#behavior-analysis" title="Permalink to this heading"></a></h2>
<section id="id11">
<h3>Technique<a class="headerlink" href="#id11" title="Permalink to this heading"></a></h3>
<p>Some actions that malware typically performs are inherently suspicious:
Process hollowing, accessing honey tokens, getting a handle on the LSASS
process, etc.</p>
<p>These actions are detectable in principle, and that’s one of the techniques
employed by modern antivirus products. The only issue is that not all
actions are inherently suspicious but still considered malware. Whatever
<a class="reference external" href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a> does, for example.</p>
</section>
<section id="id12">
<h3>Our Bypass<a class="headerlink" href="#id12" title="Permalink to this heading"></a></h3>
<p>Yeah I got nothing. Dear friends from Kaspersky, Palo Alto and Windows
Defender: That’s where I’d focus. Good luck.</p>
</section>
</section>
<section id="counter-measures">
<h2>Counter measures<a class="headerlink" href="#counter-measures" title="Permalink to this heading"></a></h2>
<p>So what you can do as a defender about software like PowerHub?</p>
<p>It’s simple:</p>
<ul class="simple">
<li><p>Enable constrained language mode</p></li>
<li><p>Make sure PowerShell version 2 is disabled</p></li>
<li><p>Block all executables in user-writable directories as well as <a class="reference external" href="https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/microsoft-recommended-block-rules">these LOLBINs</a></p></li>
<li><p>Fine, also allow signed binaries matching a fixed list of product names like
“Microsoft Teams” even if they are located in writable directories</p></li>
</ul>
<p>(Hey, no one said it would be easy, I only said it was simple …)</p>
<p>And don’t get too hung up on this tool. These techniques are not new and not
unique to PowerHub. Antivirus products can <em>always</em> be tricked. They are
insufficient and you should apply application control instead, for example
using AppLocker or Application Guard.</p>
</section>
</section>


           </div>
          </div>
<a href="https://github.com/AdrianVollmer/PowerHub" target="_blank"><img decoding="async" loading="lazy" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_white_ffffff.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1" style="position: absolute; top: 0; right: 0; border: 0;"></a>

          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="changelog.html" class="btn btn-neutral float-left" title="Changelog" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="usage.html" class="btn btn-neutral float-right" title="Usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023, Adrian Vollmer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 2.0.7
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Versions</dt>
        
          
          <dd><a href="/PowerHub/2.0.0/">2.0.0</a></dd>
          
        
          
          <dd><a href="/PowerHub/2.0.1/">2.0.1</a></dd>
          
        
          
          <dd><a href="/PowerHub/2.0.2/">2.0.2</a></dd>
          
        
          
          <dd><a href="/PowerHub/2.0.3/">2.0.3</a></dd>
          
        
          
          <dd><a href="/PowerHub/2.0.4/">2.0.4</a></dd>
          
        
          
          <dd><a href="/PowerHub/2.0.5/">2.0.5</a></dd>
          
        
          
          <dd><a href="/PowerHub/2.0.6/">2.0.6</a></dd>
          
        
           <strong> 
          <dd><a href="/PowerHub/2.0.7/">2.0.7</a></dd>
           </strong> 
        
          
          <dd><a href="/PowerHub/latest/">latest</a></dd>
          
        
          
          <dd><a href="/PowerHub/master/">master</a></dd>
          
        
      </dl>
      
      <hr/>
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <link rel="stylesheet" type="text/css" href="_static/custom.css">



</body>
</html>